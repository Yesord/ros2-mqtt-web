<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROS2 MQTT ç›‘æ§é¢æ¿ - Bentoé£æ ¼</title>
    <style>
        /* å¯¼å…¥Googleå­—ä½“ - Bentoé£æ ¼ä½¿ç”¨SF Pro Display / Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=SF+Mono:wght@400;500;600&display=swap');
        
        :root {
            /* Bentoé£æ ¼è‰²å½©ç³»ç»Ÿ */
            --bg-primary: #fafafa;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --surface-white: #ffffff;
            --surface-light: #f8f9fa;
            --surface-medium: #e9ecef;
            --surface-dark: #dee2e6;
            
            /* æ–‡å­—é¢œè‰² */
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --text-white: #ffffff;
            
            /* å“ç‰Œè‰²å½© */
            --accent-blue: #007aff;
            --accent-green: #34c759;
            --accent-orange: #ff9500;
            --accent-red: #ff3b30;
            --accent-purple: #af52de;
            --accent-pink: #ff2d92;
            --accent-yellow: #ffcc02;
            --accent-indigo: #5856d6;
            
            /* æ¸å˜ */
            --gradient-blue: linear-gradient(135deg, #007aff 0%, #5856d6 100%);
            --gradient-green: linear-gradient(135deg, #34c759 0%, #30d158 100%);
            --gradient-orange: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
            --gradient-purple: linear-gradient(135deg, #af52de 0%, #ff2d92 100%);
            
            /* é˜´å½±ç³»ç»Ÿ */
            --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            /* è¾¹è·ç³»ç»Ÿ */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            
            /* åœ†è§’ç³»ç»Ÿ */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-2xl: 24px;
            --radius-full: 50px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-xl);
            min-height: 100vh;
        }

        /* Bentoç½‘æ ¼å¸ƒå±€ */
        .bento-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: repeat(auto-fit, minmax(120px, auto));
            gap: var(--spacing-lg);
            grid-auto-rows: minmax(120px, auto);
        }

        /* Bentoå¡ç‰‡åŸºç¡€æ ·å¼ */
        .bento-card {
            background: var(--surface-white);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--surface-medium);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .bento-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--surface-dark);
        }

        /* ç½‘æ ¼åŒºåŸŸå®šä¹‰ */
        .header-card {
            grid-column: 1 / -1;
            grid-row: 1 / 2;
            background: var(--gradient-blue);
            color: var(--text-white);
            text-align: center;
            padding: var(--spacing-2xl);
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .status-card {
            grid-column: 1 / 5;
            grid-row: 2 / 3;
            background: var(--surface-white);
        }

        .config-card {
            grid-column: 5 / 9;
            grid-row: 2 / 4;
            background: var(--surface-white);
        }

        .topics-management-card {
            grid-column: 9 / -1;
            grid-row: 2 / 4;
            background: var(--surface-white);
        }

        .stats-card {
            grid-column: 1 / 5;
            grid-row: 3 / 4;
            background: var(--gradient-green);
            color: var(--text-white);
        }

        .active-topics-card {
            grid-column: 1 / 9;
            grid-row: 4 / 6;
            background: var(--surface-white);
        }

        .quick-actions-card {
            grid-column: 9 / -1;
            grid-row: 4 / 5;
            background: var(--surface-light);
        }

        .subscribed-topics-card {
            grid-column: 9 / -1;
            grid-row: 5 / 6;
            background: var(--surface-white);
        }

        .messages-display-card {
            grid-column: 1 / -1;
            grid-row: 6 / -1;
            background: var(--surface-white);
            min-height: 600px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        .header-card h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: var(--spacing-sm);
            letter-spacing: -0.02em;
        }

        .header-card p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            font-weight: 500;
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-lg);
            background: var(--surface-light);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: var(--radius-full);
            background: var(--accent-red);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--accent-green);
        }

        .status-dot.connecting {
            background: var(--accent-orange);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .status-text {
            font-weight: 600;
            color: var(--text-primary);
        }

        .time-display {
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            background: var(--surface-medium);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-sm);
        }

        /* è¡¨å•å…ƒç´  */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--surface-light);
            border: 1px solid var(--surface-medium);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
            background: var(--surface-white);
        }

        /* æŒ‰é’®ç³»ç»Ÿ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--accent-blue);
            color: var(--text-white);
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
            background: #0056b3;
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--surface-medium);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary { background: var(--accent-blue); }
        .btn-success { background: var(--accent-green); }
        .btn-warning { background: var(--accent-orange); }
        .btn-danger { background: var(--accent-red); }
        .btn-purple { background: var(--accent-purple); }

        .btn-small {
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: 0.75rem;
            border-radius: var(--radius-sm);
        }

        .btn-large {
            padding: var(--spacing-lg) var(--spacing-xl);
            font-size: 1rem;
            border-radius: var(--radius-lg);
        }

        .btn-full {
            width: 100%;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin-top: var(--spacing-md);
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-white);
            margin-bottom: var(--spacing-xs);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* è¯é¢˜å¡ç‰‡ */
        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .topic-card {
            background: var(--surface-light);
            border: 1px solid var(--surface-medium);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            transition: all 0.2s ease;
            position: relative;
        }

        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--accent-blue);
        }

        .topic-card.active {
            border-color: var(--accent-green);
            background: var(--surface-white);
        }

        .topic-card.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-green);
            border-radius: var(--radius-sm) 0 0 var(--radius-sm);
        }

        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .topic-name {
            font-weight: 700;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .topic-status {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: var(--accent-green);
        }

        .status-inactive {
            background: rgba(255, 59, 48, 0.1);
            color: var(--accent-red);
        }

        .topic-content {
            background: var(--surface-white);
            border: 1px solid var(--surface-medium);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            color: var(--text-secondary);
        }

        .topic-meta {
            display: flex;
            justify-content: space-between;
            margin-top: var(--spacing-md);
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .topic-controls {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        /* æ ‡ç­¾ç³»ç»Ÿ */
        .tag {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: var(--spacing-xs) var(--spacing-sm);
            background: var(--surface-medium);
            color: var(--text-secondary);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-blue { background: rgba(0, 122, 255, 0.1); color: var(--accent-blue); }
        .tag-green { background: rgba(52, 199, 89, 0.1); color: var(--accent-green); }
        .tag-orange { background: rgba(255, 149, 0, 0.1); color: var(--accent-orange); }
        .tag-red { background: rgba(255, 59, 48, 0.1); color: var(--accent-red); }

        /* åˆ—è¡¨æ ·å¼ */
        .topic-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .topic-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--surface-light);
            border: 1px solid var(--surface-medium);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            transition: all 0.2s ease;
        }

        .topic-item:hover {
            background: var(--surface-white);
            border-color: var(--accent-blue);
            transform: translateX(2px);
        }

        .topic-item:last-child {
            margin-bottom: 0;
        }

        .topic-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--surface-medium);
            border-top: 2px solid var(--accent-blue);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface-light);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--surface-dark);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-tertiary);
        }

        .empty-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.6;
        }

        .empty-text {
            font-weight: 500;
            margin-bottom: var(--spacing-sm);
        }

        .empty-subtext {
            font-size: 0.875rem;
            color: var(--text-tertiary);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .bento-grid {
                grid-template-columns: repeat(8, 1fr);
            }
            
            .status-card { grid-column: 1 / -1; grid-row: 2 / 3; }
            .config-card { grid-column: 1 / 5; grid-row: 3 / 5; }
            .topics-management-card { grid-column: 5 / -1; grid-row: 3 / 5; }
            .stats-card { grid-column: 1 / -1; grid-row: 5 / 6; }
            .active-topics-card { grid-column: 1 / -1; grid-row: 6 / 8; }
            .quick-actions-card { grid-column: 1 / 5; grid-row: 8 / 9; }
            .subscribed-topics-card { grid-column: 5 / -1; grid-row: 8 / 9; }
            .messages-display-card { grid-column: 1 / -1; grid-row: 9 / -1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--spacing-md);
            }
            
            .bento-grid {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .header-card,
            .status-card,
            .config-card,
            .topics-management-card,
            .stats-card,
            .active-topics-card,
            .quick-actions-card,
            .subscribed-topics-card,
            .messages-display-card {
                grid-column: 1 / -1;
            }
            
            .header-card h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .topics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="bento-grid">
            <!-- é¡µé¢æ ‡é¢˜å¡ç‰‡ -->
            <div class="bento-card header-card">
                <h1>ğŸš€ ROS2 MQTT ç›‘æ§é¢æ¿</h1>
                <p>å®æ—¶ç›‘æ§å¤šä¸ªROS2è¯é¢˜çš„MQTTæ•°æ®æµ</p>
            </div>

            <!-- è¿æ¥çŠ¶æ€å¡ç‰‡ -->
            <div class="bento-card status-card">
                <h2 class="card-title">ğŸ”— è¿æ¥çŠ¶æ€</h2>
                <div class="status-indicator">
                    <div id="status-dot" class="status-dot"></div>
                    <div>
                        <div id="status-text" class="status-text">æœªè¿æ¥</div>
                        <div class="time-display">
                            <span id="current-time">--:--:--</span>
                        </div>
                    </div>
                    <div class="loading" id="loading-indicator" style="display: none;"></div>
                </div>
            </div>

            <!-- MQTTé…ç½®å¡ç‰‡ -->
            <div class="bento-card config-card">
                <h2 class="card-title">âš™ï¸ MQTTé…ç½®</h2>
                <div class="form-group">
                    <label class="form-label" for="mqtt-host">æœåŠ¡å™¨åœ°å€</label>
                    <input class="form-input" type="text" id="mqtt-host" value="localhost" placeholder="localhost">
                </div>
                <div class="form-group">
                    <label class="form-label" for="mqtt-port">WebSocketç«¯å£</label>
                    <input class="form-input" type="number" id="mqtt-port" value="9001" placeholder="9001">
                </div>
                <div class="form-group">
                    <label class="form-label" for="topic-prefix">è¯é¢˜å‰ç¼€</label>
                    <input class="form-input" type="text" id="topic-prefix" value="ros2" placeholder="ros2">
                </div>
                <button id="connect-btn" class="btn btn-primary btn-full">
                    ğŸ”Œ è¿æ¥ MQTT
                </button>
            </div>

            <!-- è¯é¢˜ç®¡ç†å¡ç‰‡ -->
            <div class="bento-card topics-management-card">
                <h2 class="card-title">ğŸ“¡ è¯é¢˜ç®¡ç†</h2>
                <div class="form-group">
                    <label class="form-label" for="topic-name">è¯é¢˜åç§°</label>
                    <input class="form-input" type="text" id="topic-name" placeholder="hello_world/data">
                </div>
                <button id="add-topic-btn" class="btn btn-success btn-full" disabled>
                    â• æ·»åŠ è¯é¢˜
                </button>
                
                <div class="card-subtitle">é¢„è®¾è¯é¢˜</div>
                <div style="display: flex; flex-wrap: wrap; gap: var(--spacing-sm);">
                    <button class="btn btn-small btn-success" onclick="monitor.addPresetTopic('hello_world/data')">Hello World</button>
                    <button class="btn btn-small btn-success" onclick="monitor.addPresetTopic('turtle/cmd_vel')">Turtleé€Ÿåº¦</button>
                    <button class="btn btn-small btn-success" onclick="monitor.addPresetTopic('gps/fix')">GPS</button>
                    <button class="btn btn-small btn-success" onclick="monitor.addPresetTopic('image_raw/metadata')">å›¾åƒå…ƒæ•°æ®</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡æ¦‚è§ˆå¡ç‰‡ -->
            <div class="bento-card stats-card">
                <h2 class="card-title">ï¿½ å®æ—¶ç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div id="total-topics" class="stat-number">0</div>
                        <div class="stat-label">è®¢é˜…è¯é¢˜</div>
                    </div>
                    <div class="stat-item">
                        <div id="total-messages" class="stat-number">0</div>
                        <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div id="messages-per-minute" class="stat-number">0</div>
                        <div class="stat-label">æ¶ˆæ¯/åˆ†é’Ÿ</div>
                    </div>
                    <div class="stat-item">
                        <div id="active-topics" class="stat-number">0</div>
                        <div class="stat-label">æ´»è·ƒè¯é¢˜</div>
                    </div>
                </div>
            </div>

            <!-- è¯é¢˜æ•°æ®æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="bento-card active-topics-card">
                <h2 class="card-title">ğŸ’¬ è¯é¢˜æ•°æ®æµ</h2>
                <div id="topics-container" class="topics-grid">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-text">æš‚æ— æ´»è·ƒè¯é¢˜</div>
                        <div class="empty-subtext">è¿æ¥MQTTå¹¶è®¢é˜…è¯é¢˜ä»¥æŸ¥çœ‹æ•°æ®</div>
                    </div>
                </div>
            </div>

            <!-- å¿«é€Ÿæ“ä½œå¡ç‰‡ -->
            <div class="bento-card quick-actions-card">
                <h2 class="card-title">âš¡ å¿«é€Ÿæ“ä½œ</h2>
                <button id="clear-all-btn" class="btn btn-danger btn-full btn-small">
                    ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è¯é¢˜
                </button>
                <button id="export-all-btn" class="btn btn-purple btn-full btn-small">
                    ğŸ’¾ å¯¼å‡ºæ‰€æœ‰æ•°æ®
                </button>
                <button id="refresh-btn" class="btn btn-warning btn-full btn-small">
                    ğŸ”„ åˆ·æ–°è¿æ¥
                </button>
            </div>

            <!-- å·²è®¢é˜…è¯é¢˜åˆ—è¡¨ -->
            <div class="bento-card subscribed-topics-card">
                <h2 class="card-title">ğŸ“‹ å·²è®¢é˜…è¯é¢˜</h2>
                <div id="subscribed-topics" class="topic-list">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“</div>
                        <div class="empty-text">æš‚æ— è®¢é˜…</div>
                        <div class="empty-subtext">æ·»åŠ è¯é¢˜å¼€å§‹ç›‘æ§</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ MQTT.js åº“ -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    
    <script>
        class ROS2MQTTMonitor {
            constructor() {
                this.client = null;
                this.isConnected = false;
                this.subscribedTopics = new Map();
                this.totalMessages = 0;
                this.messagesThisMinute = 0;
                this.connectionStartTime = null;
                
                this.initializeElements();
                this.bindEvents();
                this.startUpdaters();
            }

            initializeElements() {
                // çŠ¶æ€å…ƒç´ 
                this.statusDot = document.getElementById('status-dot');
                this.statusText = document.getElementById('status-text');
                this.loadingIndicator = document.getElementById('loading-indicator');
                
                // è¾“å…¥å…ƒç´ 
                this.hostInput = document.getElementById('mqtt-host');
                this.portInput = document.getElementById('mqtt-port');
                this.topicPrefixInput = document.getElementById('topic-prefix');
                this.topicNameInput = document.getElementById('topic-name');
                
                // æŒ‰é’®å…ƒç´ 
                this.connectBtn = document.getElementById('connect-btn');
                this.addTopicBtn = document.getElementById('add-topic-btn');
                this.clearAllBtn = document.getElementById('clear-all-btn');
                this.exportAllBtn = document.getElementById('export-all-btn');
                this.refreshBtn = document.getElementById('refresh-btn');
                
                // æ˜¾ç¤ºå…ƒç´ 
                this.currentTimeSpan = document.getElementById('current-time');
                this.subscribedTopicsDiv = document.getElementById('subscribed-topics');
                this.topicsContainer = document.getElementById('topics-container');
                
                // ç»Ÿè®¡å…ƒç´ 
                this.totalTopicsSpan = document.getElementById('total-topics');
                this.totalMessagesSpan = document.getElementById('total-messages');
                this.messagesPerMinuteSpan = document.getElementById('messages-per-minute');
                this.activeTopicsSpan = document.getElementById('active-topics');
            }

            bindEvents() {
                this.connectBtn.addEventListener('click', () => this.toggleConnection());
                this.addTopicBtn.addEventListener('click', () => this.addTopic());
                this.clearAllBtn.addEventListener('click', () => this.clearAllTopics());
                this.exportAllBtn.addEventListener('click', () => this.exportAllData());
                this.refreshBtn.addEventListener('click', () => this.refreshConnection());
                
                // å›è½¦é”®æ·»åŠ è¯é¢˜
                this.topicNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !this.addTopicBtn.disabled) {
                        this.addTopic();
                    }
                });
            }

            updateStatus(status, text) {
                // æ›´æ–°çŠ¶æ€ç‚¹
                this.statusDot.className = `status-dot ${status}`;
                this.statusText.textContent = text;
                
                // æ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
                if (status === 'connecting') {
                    this.loadingIndicator.style.display = 'inline-block';
                } else {
                    this.loadingIndicator.style.display = 'none';
                }
            }

            async toggleConnection() {
                if (this.isConnected) {
                    this.disconnect();
                } else {
                    await this.connect();
                }
            }

            async connect() {
                const host = this.hostInput.value.trim();
                const port = parseInt(this.portInput.value);
                
                if (!host || !port) {
                    this.showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„æœåŠ¡å™¨åœ°å€å’Œç«¯å£', 'error');
                    return;
                }

                this.updateStatus('connecting', 'è¿æ¥ä¸­...');
                this.connectBtn.disabled = true;

                try {
                    const wsUrl = `ws://${host}:${port}`;
                    console.log('è¿æ¥åˆ°:', wsUrl);

                    this.client = mqtt.connect(wsUrl, {
                        clientId: `ros2_monitor_${Math.random().toString(16).substr(2, 8)}`,
                        keepalive: 60,
                        reconnectPeriod: 1000,
                        connectTimeout: 30000
                    });

                    this.client.on('connect', () => {
                        console.log('MQTT è¿æ¥æˆåŠŸ');
                        this.isConnected = true;
                        this.connectionStartTime = new Date();
                        this.updateStatus('connected', 'å·²è¿æ¥');
                        this.connectBtn.textContent = 'ğŸ”Œ æ–­å¼€è¿æ¥';
                        this.connectBtn.disabled = false;
                        this.addTopicBtn.disabled = false;
                        this.showNotification('MQTTè¿æ¥æˆåŠŸï¼', 'success');
                    });

                    this.client.on('error', (error) => {
                        console.error('MQTT è¿æ¥é”™è¯¯:', error);
                        this.updateStatus('', 'è¿æ¥å¤±è´¥');
                        this.connectBtn.textContent = 'ğŸ”Œ è¿æ¥ MQTT';
                        this.connectBtn.disabled = false;
                        this.addTopicBtn.disabled = true;
                        this.showNotification('MQTTè¿æ¥å¤±è´¥', 'error');
                    });

                    this.client.on('close', () => {
                        console.log('MQTT è¿æ¥å…³é—­');
                        this.isConnected = false;
                        this.updateStatus('', 'æœªè¿æ¥');
                        this.connectBtn.textContent = 'ğŸ”Œ è¿æ¥ MQTT';
                        this.connectBtn.disabled = false;
                        this.addTopicBtn.disabled = true;
                    });

                    this.client.on('message', (topic, message) => {
                        this.handleMessage(topic, message);
                    });

                } catch (error) {
                    console.error('è¿æ¥å¤±è´¥:', error);
                    this.updateStatus('', 'è¿æ¥å¤±è´¥');
                    this.connectBtn.disabled = false;
                    this.showNotification('è¿æ¥å¤±è´¥: ' + error.message, 'error');
                }
            }

            disconnect() {
                if (this.client) {
                    this.client.end();
                    this.client = null;
                }
                this.isConnected = false;
                this.connectionStartTime = null;
            }

            refreshConnection() {
                if (this.isConnected) {
                    this.disconnect();
                    setTimeout(() => this.connect(), 1000);
                } else {
                    this.connect();
                }
            }

            addTopic() {
                const topicName = this.topicNameInput.value.trim();
                if (!topicName) {
                    this.showNotification('è¯·è¾“å…¥è¯é¢˜åç§°', 'error');
                    return;
                }
                this.addPresetTopic(topicName);
                this.topicNameInput.value = '';
            }

            addPresetTopic(topicName) {
                if (!this.isConnected) {
                    this.showNotification('è¯·å…ˆè¿æ¥ MQTT æœåŠ¡å™¨', 'error');
                    return;
                }

                const topicPrefix = this.topicPrefixInput.value.trim();
                const fullTopic = `${topicPrefix}/${topicName}`;

                if (this.subscribedTopics.has(fullTopic)) {
                    this.showNotification('è¯é¢˜å·²å­˜åœ¨', 'warning');
                    return;
                }

                console.log('è®¢é˜…è¯é¢˜:', fullTopic);
                
                this.client.subscribe(fullTopic, (error) => {
                    if (error) {
                        console.error('è®¢é˜…å¤±è´¥:', error);
                        this.showNotification('è®¢é˜…å¤±è´¥: ' + error.message, 'error');
                    } else {
                        console.log('è®¢é˜…æˆåŠŸ:', fullTopic);
                        this.subscribedTopics.set(fullTopic, {
                            name: topicName,
                            lastMessage: null,
                            messageCount: 0,
                            lastTime: null,
                            isActive: false
                        });
                        this.updateTopicsDisplay();
                        this.updateStatistics();
                        this.showNotification(`æˆåŠŸè®¢é˜…è¯é¢˜: ${topicName}`, 'success');
                    }
                });
            }

            removeTopic(fullTopic) {
                if (this.client && this.isConnected) {
                    this.client.unsubscribe(fullTopic);
                }
                const topicInfo = this.subscribedTopics.get(fullTopic);
                this.subscribedTopics.delete(fullTopic);
                this.updateTopicsDisplay();
                this.updateStatistics();
                this.showNotification(`å·²å–æ¶ˆè®¢é˜…: ${topicInfo.name}`, 'success');
            }

            clearAllTopics() {
                if (this.subscribedTopics.size === 0) {
                    this.showNotification('æ²¡æœ‰è¯é¢˜éœ€è¦æ¸…ç©º', 'warning');
                    return;
                }

                if (confirm('ç¡®å®šè¦å–æ¶ˆè®¢é˜…æ‰€æœ‰è¯é¢˜å—ï¼Ÿ')) {
                    for (const topic of this.subscribedTopics.keys()) {
                        if (this.client && this.isConnected) {
                            this.client.unsubscribe(topic);
                        }
                    }
                    this.subscribedTopics.clear();
                    this.updateTopicsDisplay();
                    this.updateStatistics();
                    this.showNotification('å·²æ¸…ç©ºæ‰€æœ‰è¯é¢˜', 'success');
                }
            }

            handleMessage(topic, message) {
                try {
                    const messageStr = message.toString();
                    let messageData;
                    
                    console.log('æ”¶åˆ°æ¶ˆæ¯:', topic, messageStr.substring(0, 100));

                    try {
                        messageData = JSON.parse(messageStr);
                    } catch {
                        messageData = messageStr;
                    }

                    if (this.subscribedTopics.has(topic)) {
                        const topicInfo = this.subscribedTopics.get(topic);
                        topicInfo.lastMessage = messageData;
                        topicInfo.messageCount++;
                        topicInfo.lastTime = new Date();
                        topicInfo.isActive = true;
                        this.subscribedTopics.set(topic, topicInfo);
                    }

                    this.totalMessages++;
                    this.messagesThisMinute++;
                    this.updateTopicsDisplay();
                    this.updateStatistics();

                } catch (error) {
                    console.error('å¤„ç†æ¶ˆæ¯å¤±è´¥:', error);
                }
            }

            updateTopicsDisplay() {
                // æ›´æ–°å·²è®¢é˜…è¯é¢˜åˆ—è¡¨
                if (this.subscribedTopics.size === 0) {
                    this.subscribedTopicsDiv.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“</div>
                            <div class="empty-text">æš‚æ— è®¢é˜…</div>
                            <div class="empty-subtext">æ·»åŠ è¯é¢˜å¼€å§‹ç›‘æ§</div>
                        </div>
                    `;
                } else {
                    this.subscribedTopicsDiv.innerHTML = Array.from(this.subscribedTopics.entries())
                        .map(([fullTopic, info]) => `
                            <div class="topic-item">
                                <span class="topic-item-name">${info.name}</span>
                                <span class="tag ${info.isActive ? 'tag-green' : 'tag-red'}">
                                    ${info.messageCount}
                                </span>
                                <button class="btn btn-small btn-danger" onclick="monitor.removeTopic('${fullTopic}')">
                                    âŒ
                                </button>
                            </div>
                        `).join('');
                }

                // æ›´æ–°ä¸»åŒºåŸŸè¯é¢˜å¡ç‰‡
                if (this.subscribedTopics.size === 0) {
                    this.topicsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div class="empty-text">æš‚æ— æ´»è·ƒè¯é¢˜</div>
                            <div class="empty-subtext">è¿æ¥MQTTå¹¶è®¢é˜…è¯é¢˜ä»¥æŸ¥çœ‹æ•°æ®</div>
                        </div>
                    `;
                } else {
                    this.topicsContainer.innerHTML = Array.from(this.subscribedTopics.entries())
                        .map(([fullTopic, info]) => {
                            const messagePreview = this.formatMessagePreview(info.lastMessage);
                            const isActive = info.isActive && info.lastTime && 
                                            (new Date() - info.lastTime) < 60000;
                            
                            return `
                                <div class="topic-card ${isActive ? 'active' : ''}">
                                    <div class="topic-header">
                                        <div class="topic-name">${info.name}</div>
                                        <div class="topic-status ${isActive ? 'status-active' : 'status-inactive'}">
                                            ${isActive ? 'ğŸŸ¢ æ´»è·ƒ' : 'ğŸ”´ é™é»˜'}
                                        </div>
                                    </div>
                                    <div class="topic-content ${info.lastMessage ? 'has-data' : ''}">
                                        ${messagePreview}
                                    </div>
                                    <div class="topic-meta">
                                        <span>æ¶ˆæ¯: ${info.messageCount}</span>
                                        <span>${info.lastTime ? info.lastTime.toLocaleTimeString() : 'æ— æ•°æ®'}</span>
                                    </div>
                                    <div class="topic-controls">
                                        <button class="btn btn-small btn-danger" onclick="monitor.removeTopic('${fullTopic}')">
                                            âŒ å–æ¶ˆ
                                        </button>
                                        <button class="btn btn-small btn-success" onclick="monitor.exportTopicData('${fullTopic}')">
                                            ğŸ’¾ å¯¼å‡º
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                }
            }

            formatMessagePreview(message) {
                if (!message) {
                    return '<div style="color: var(--text-tertiary); font-style: italic;">ç­‰å¾…æ¶ˆæ¯...</div>';
                }

                if (typeof message === 'object') {
                    if (message.data !== undefined) {
                        return `<div><strong>æ•°æ®:</strong> ${this.escapeHtml(String(message.data))}</div>`;
                    } else if (message.linear && message.angular) {
                        return `<div><strong>çº¿é€Ÿåº¦:</strong> ${message.linear.x || 0}<br><strong>è§’é€Ÿåº¦:</strong> ${message.angular.z || 0}</div>`;
                    } else if (message.latitude && message.longitude) {
                        return `<div><strong>çº¬åº¦:</strong> ${message.latitude}<br><strong>ç»åº¦:</strong> ${message.longitude}</div>`;
                    } else {
                        const preview = JSON.stringify(message, null, 2);
                        return `<pre style="white-space: pre-wrap; font-size: 0.8em;">${this.escapeHtml(preview.substring(0, 200))}${preview.length > 200 ? '...' : ''}</pre>`;
                    }
                } else {
                    const str = String(message);
                    return `<div>${this.escapeHtml(str.substring(0, 200))}${str.length > 200 ? '...' : ''}</div>`;
                }
            }

            updateStatistics() {
                this.totalTopicsSpan.textContent = this.subscribedTopics.size;
                this.totalMessagesSpan.textContent = this.totalMessages;
                this.messagesPerMinuteSpan.textContent = this.messagesThisMinute;
                
                const now = new Date();
                const activeCount = Array.from(this.subscribedTopics.values())
                    .filter(info => info.lastTime && (now - info.lastTime) < 60000)
                    .length;
                this.activeTopicsSpan.textContent = activeCount;
            }

            exportTopicData(fullTopic) {
                const topicInfo = this.subscribedTopics.get(fullTopic);
                if (!topicInfo) return;

                const data = {
                    topic: fullTopic,
                    exportTime: new Date().toISOString(),
                    messageCount: topicInfo.messageCount,
                    lastMessage: topicInfo.lastMessage,
                    lastTime: topicInfo.lastTime
                };

                this.downloadJson(data, `${topicInfo.name}_${new Date().toISOString().slice(0, 19)}.json`);
                this.showNotification(`å·²å¯¼å‡ºè¯é¢˜æ•°æ®: ${topicInfo.name}`, 'success');
            }

            exportAllData() {
                if (this.subscribedTopics.size === 0) {
                    this.showNotification('æ²¡æœ‰æ•°æ®å¯ä»¥å¯¼å‡º', 'warning');
                    return;
                }

                const allData = {
                    exportTime: new Date().toISOString(),
                    totalTopics: this.subscribedTopics.size,
                    totalMessages: this.totalMessages,
                    topics: Array.from(this.subscribedTopics.entries()).map(([topic, info]) => ({
                        topic,
                        name: info.name,
                        messageCount: info.messageCount,
                        lastMessage: info.lastMessage,
                        lastTime: info.lastTime,
                        isActive: info.isActive
                    }))
                };

                this.downloadJson(allData, `ros2_mqtt_monitor_${new Date().toISOString().slice(0, 19)}.json`);
                this.showNotification('å·²å¯¼å‡ºæ‰€æœ‰æ•°æ®', 'success');
            }

            downloadJson(data, filename) {
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            showNotification(message, type = 'info') {
                // ç®€å•çš„é€šçŸ¥ç³»ç»Ÿ
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 12px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 1000;
                    transition: all 0.3s ease;
                    max-width: 300px;
                `;
                
                switch (type) {
                    case 'success':
                        notification.style.background = 'var(--accent-green)';
                        break;
                    case 'error':
                        notification.style.background = 'var(--accent-red)';
                        break;
                    case 'warning':
                        notification.style.background = 'var(--accent-orange)';
                        break;
                    default:
                        notification.style.background = 'var(--accent-blue)';
                }
                
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            startUpdaters() {
                // æ—¶é—´æ›´æ–°å™¨
                setInterval(() => {
                    this.currentTimeSpan.textContent = new Date().toLocaleTimeString();
                }, 1000);

                // æ¯åˆ†é’Ÿé‡ç½®æ¶ˆæ¯è®¡æ•°å™¨
                setInterval(() => {
                    this.messagesThisMinute = 0;
                    this.updateStatistics();
                }, 60000);

                // å®šæœŸæ›´æ–°æ˜¾ç¤º
                setInterval(() => {
                    this.updateTopicsDisplay();
                    this.updateStatistics();
                }, 5000);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        let monitor;
        document.addEventListener('DOMContentLoaded', () => {
            monitor = new ROS2MQTTMonitor();
        });
    </script>
</body>
</html>
