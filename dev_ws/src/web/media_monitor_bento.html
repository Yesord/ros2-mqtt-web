<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROS2 MQTT å›¾åƒæµç›‘æ§</title>
    <link rel="stylesheet" href="css/media_monitor_bento.css">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <!-- å¼•å…¥ js-yaml ç”¨äºè§£æ YAML é…ç½® -->
    <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
</head>
<body>
    <div class="bento-container">
        <!-- å¤´éƒ¨çŠ¶æ€å¡ç‰‡ -->
        <div class="bento-card header-card">
            <div class="card-content">
                <div class="title-section">
                    <div class="app-icon">ğŸ“·</div>
                    <div class="title-text">
                        <h1>å›¾åƒæµç›‘æ§</h1>
                        <p>å®æ—¶Base64å›¾åƒè§£ç æ˜¾ç¤º</p>
                    </div>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <div class="status-indicator disconnected"></div>
                    <span class="status-text">æœªè¿æ¥</span>
                </div>
            </div>
        </div>

        <!-- è¿æ¥é…ç½®å¡ç‰‡ -->
        <div class="bento-card config-card">
            <div class="card-header">
                <h3>è¿æ¥è®¾ç½®</h3>
                <button id="toggleConfig" class="toggle-btn">âˆ§</button>
            </div>
            <div class="card-content" id="configContent">
                <div class="input-group">
                    <label>MQTTæœåŠ¡å™¨</label>
                    <input type="text" id="brokerHost" value="localhost" placeholder="localhost">
                </div>
                <div class="input-group">
                    <label>ç«¯å£</label>
                    <input type="number" id="brokerPort" value="9001" placeholder="9001">
                </div>
                <div class="input-group">
                    <label>å®¢æˆ·ç«¯ID</label>
                    <input type="text" id="clientId" value="monitor_client" placeholder="monitor_client">
                </div>
                <div class="connection-buttons">
                    <button id="connectBtn" class="primary-btn">è¿æ¥</button>
                    <button id="disconnectBtn" class="secondary-btn" disabled>æ–­å¼€</button>
                </div>
            </div>
        </div>

        <!-- ä¸»é¢˜è®¢é˜…å¡ç‰‡ -->
        <div class="bento-card subscription-card">
            <div class="card-header">
                <h3>å›¾åƒè¯é¢˜</h3>
                <div class="topic-input-group">
                    <input type="text" id="topicInput" placeholder="ros2/image_compressed/data">
                    <button id="addTopicBtn" class="add-btn">+</button>
                </div>
            </div>
            <div class="card-content">
                <div class="preset-topics">
                    <button class="preset-topic-btn" data-topic="ros2/image_compressed/data">
                        ğŸ¥ å‹ç¼©å›¾åƒæµ
                    </button>
                    <button class="preset-topic-btn" data-topic="ros2/image_raw/data">
                        ğŸ“· åŸå§‹å›¾åƒ
                    </button>
                    <button class="preset-topic-btn" data-topic="ros2/camera/image">
                        ğŸ“¸ ç›¸æœºå›¾åƒ
                    </button>
                </div>
                <div class="active-topics" id="activeTopicsList">
                    <!-- æ´»è·ƒè¯é¢˜åˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- è§†é¢‘æµæ˜¾ç¤ºå¡ç‰‡ -->
        <div class="bento-card video-stream-card">
            <div class="card-header">
                <h3>å®æ—¶è§†é¢‘æµ</h3>
                <div class="stream-controls">
                    <button id="playBtn" class="control-btn">â–¶ï¸</button>
                    <button id="pauseBtn" class="control-btn">â¸ï¸</button>
                    <button id="fullscreenBtn" class="control-btn">â›¶</button>
                    <span class="fps-indicator" id="fpsDisplay">0 FPS</span>
                </div>
            </div>
            <div class="card-content">
                <div class="video-container" id="videoContainer">
                    <canvas id="videoCanvas" width="640" height="480"></canvas>
                    <div class="video-overlay">
                        <div class="no-signal" id="noSignal">
                            <div class="no-signal-icon">ğŸ“º</div>
                            <p>ç­‰å¾…å›¾åƒæ•°æ®...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€æ–°å›¾åƒå¡ç‰‡ -->
        <div class="bento-card latest-image-card">
            <div class="card-header">
                <h3>æœ€æ–°å›¾åƒ</h3>
                <div class="image-controls">
                    <button id="saveImageBtn" class="control-btn">ğŸ’¾</button>
                    <button id="clearImageBtn" class="control-btn">ï¿½ï¸</button>
                </div>
            </div>
            <div class="card-content">
                <div class="image-container" id="imageContainer">
                    <img id="latestImage" alt="æœ€æ–°å›¾åƒ">
                    <div class="image-info" id="imageInfo">
                        <span class="timestamp">--:--:--</span>
                        <span class="dimensions">-- x --</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡ -->
        <div class="bento-card stats-card">
            <div class="card-header">
                <h3>å®æ—¶ç»Ÿè®¡</h3>
            </div>
            <div class="card-content">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="totalMessagesCount">0</div>
                        <div class="stat-label">æ€»æ¶ˆæ¯æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalImagesCount">0</div>
                        <div class="stat-label">å›¾åƒæ•°é‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="dataTransferredCount">0 MB</div>
                        <div class="stat-label">æ•°æ®ä¼ è¾“</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="sessionTimeCount">00:00:00</div>
                        <div class="stat-label">ä¼šè¯æ—¶é—´</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿å¡ç‰‡ -->
        <div class="bento-card controls-card">
            <div class="card-header">
                <h3>æ˜¾ç¤ºæ§åˆ¶</h3>
            </div>
            <div class="card-content">
                <div class="control-group">
                    <label>å¸§ç‡é™åˆ¶</label>
                    <div class="slider-container">
                        <input type="range" id="frameRateSlider" min="1" max="60" value="30">
                        <span id="frameRateValue">30 FPS</span>
                    </div>
                </div>
                <div class="control-group">
                    <label>ç¼“å†²åŒºå¤§å°</label>
                    <div class="slider-container">
                        <input type="range" id="bufferSizeSlider" min="10" max="100" value="30">
                        <span id="bufferSizeValue">30 å¸§</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="toggle-switches">
                        <label class="switch">
                            <input type="checkbox" id="autoPlaySwitch" checked>
                            <span class="slider-switch"></span>
                            è‡ªåŠ¨æ’­æ”¾
                        </label>
                        <label class="switch">
                            <input type="checkbox" id="loopPlaybackSwitch">
                            <span class="slider-switch"></span>
                            å¾ªç¯æ’­æ”¾
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨å±æŸ¥çœ‹å™¨ -->
    <div id="fullscreenModal" class="fullscreen-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>å…¨å±æŸ¥çœ‹</h3>
                <button id="closeModalBtn" class="close-btn">âœ•</button>
            </div>
            <div class="modal-body">
                <canvas id="fullscreenCanvas"></canvas>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ç³»ç»Ÿ -->
    <div id="notifications" class="notifications-container"></div>

    <!-- åŠ è½½è„šæœ¬ -->
    <script src="js/media_monitor_bento.js"></script>
    <script>
    // è‡ªåŠ¨è¯»å– config/media_monitor_config.yaml å¹¶å¡«å…… MQTT é…ç½®
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const resp = await fetch('config/media_monitor_config.yaml');
            if (!resp.ok) return;
            const yamlText = await resp.text();
            const config = jsyaml.load(yamlText);
            if (config && config.mqtt) {
                const hostInput = document.getElementById('brokerHost');
                const portInput = document.getElementById('brokerPort');
                const clientIdInput = document.getElementById('clientId');
                if (hostInput) hostInput.value = config.mqtt.host || '';
                if (portInput) portInput.value = config.mqtt.port || '';
                if (clientIdInput && config.mqtt.client_id) clientIdInput.value = config.mqtt.client_id;
            }
        } catch (e) {
            console.warn('æ— æ³•åŠ è½½åª’ä½“ç›‘æ§MQTTé…ç½®:', e);
        }
    });
    </script>
</body>
</html>
