# MQTTå›¾åƒæ¥æ”¶å™¨ - å‹ç¼©æ‰“åŒ…åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ–°å¢åŠŸèƒ½

å¢å¼ºç‰ˆçš„MQTTå›¾åƒæ¥æ”¶å™¨ç°åœ¨æ”¯æŒ**è‡ªåŠ¨å‹ç¼©æ‰“åŒ…**åŠŸèƒ½ï¼Œå¯ä»¥å°†æ¥æ”¶åˆ°çš„å›¾ç‰‡è‡ªåŠ¨æ‰“åŒ…æˆZIPæ–‡ä»¶ï¼Œä¾¿äºå­˜å‚¨å’Œä¼ è¾“ã€‚

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨ï¼ˆä¸å¯ç”¨å‹ç¼©ï¼‰
```bash
python3 mqtt_image_receiver.py
```

### 2. å¯ç”¨è‡ªåŠ¨å‹ç¼©æ‰“åŒ…
```bash
# æ¯10å¼ å›¾ç‰‡æ‰“åŒ…ä¸€æ¬¡ï¼ˆé»˜è®¤ï¼‰
python3 mqtt_image_receiver.py --enable-archive

# è‡ªå®šä¹‰æ‰¹æ¬¡å¤§å°ï¼šæ¯5å¼ å›¾ç‰‡æ‰“åŒ…ä¸€æ¬¡
python3 mqtt_image_receiver.py --enable-archive --archive-batch-size 5

# æŒ‡å®šå‹ç¼©åŒ…ä¿å­˜ç›®å½•
python3 mqtt_image_receiver.py --enable-archive --archive-dir my_archives

# å®Œæ•´å‚æ•°ç¤ºä¾‹
python3 mqtt_image_receiver.py \
  --host localhost \
  --port 1883 \
  --save-dir received_images \
  --enable-archive \
  --archive-batch-size 20 \
  --archive-dir compressed_batches
```

## ğŸ“‹ å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | ç¤ºä¾‹ |
|------|------|--------|------|
| `--host` | MQTTæœåŠ¡å™¨åœ°å€ | `localhost` | `--host 192.168.1.100` |
| `--port` | MQTTæœåŠ¡å™¨ç«¯å£ | `1883` | `--port 8883` |
| `--save-dir` | å›¾åƒä¿å­˜ç›®å½• | `mqtt_images` | `--save-dir my_images` |
| `--enable-archive` | å¯ç”¨å‹ç¼©æ‰“åŒ… | ç¦ç”¨ | `--enable-archive` |
| `--archive-batch-size` | æ¯åŒ…å›¾ç‰‡æ•°é‡ | `10` | `--archive-batch-size 5` |
| `--archive-dir` | å‹ç¼©åŒ…ç›®å½• | `mqtt_archives` | `--archive-dir backups` |

## ğŸ“¦ å‹ç¼©æ‰“åŒ…åŠŸèƒ½ç‰¹æ€§

### è‡ªåŠ¨æ‰“åŒ…
- âœ… è¾¾åˆ°æŒ‡å®šæ•°é‡æ—¶è‡ªåŠ¨åˆ›å»ºå‹ç¼©åŒ…
- âœ… é€€å‡ºæ—¶è‡ªåŠ¨å¤„ç†å‰©ä½™æ–‡ä»¶
- âœ… æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼ï¼ˆJPGã€PNGã€BINç­‰ï¼‰

### å‹ç¼©ä¿¡æ¯
- ğŸ“Š æ˜¾ç¤ºåŸå§‹å¤§å°ã€å‹ç¼©åå¤§å°
- ğŸ“Š è®¡ç®—å‹ç¼©ç‡ç™¾åˆ†æ¯”
- ğŸ“Š å®æ—¶æ˜¾ç¤ºæ‰“åŒ…è¿›åº¦

### æ–‡ä»¶å‘½å
```
å‹ç¼©åŒ…å‘½åæ ¼å¼ï¼šmqtt_images_batch_åºå·_æ—¶é—´æˆ³.zip
ç¤ºä¾‹ï¼šmqtt_images_batch_0001_20250722_143256.zip
```

## ğŸ“ ç›®å½•ç»“æ„ç¤ºä¾‹

```
å·¥ä½œç›®å½•/
â”œâ”€â”€ mqtt_images/                    # åŸå§‹å›¾ç‰‡ç›®å½•
â”‚   â”œâ”€â”€ ros2_image_compressed_data_20250722_143201_001_0001.jpg
â”‚   â”œâ”€â”€ ros2_image_compressed_data_20250722_143202_002_0002.jpg
â”‚   â””â”€â”€ ...
â””â”€â”€ mqtt_archives/                  # å‹ç¼©åŒ…ç›®å½•
    â”œâ”€â”€ mqtt_images_batch_0001_20250722_143210.zip
    â”œâ”€â”€ mqtt_images_batch_0002_20250722_143220.zip
    â””â”€â”€ ...
```

## ğŸ’» è¿è¡Œç¤ºä¾‹

### ç¤ºä¾‹1ï¼šåŸºæœ¬å‹ç¼©åŠŸèƒ½
```bash
$ python3 mqtt_image_receiver.py --enable-archive --archive-batch-size 5
============================================================
MQTTå›¾åƒæ¥æ”¶å™¨é…ç½®:
  MQTTæœåŠ¡å™¨: localhost:1883
  å›¾åƒä¿å­˜ç›®å½•: mqtt_images
  å‹ç¼©æ‰“åŒ…: å¯ç”¨
  æ‰¹æ¬¡å¤§å°: 5 å¼ å›¾ç‰‡/åŒ…
  å‹ç¼©åŒ…ç›®å½•: mqtt_archives
============================================================
å›¾åƒä¿å­˜ç›®å½•: /home/user/mqtt_images
å‹ç¼©åŒ…ä¿å­˜ç›®å½•: /home/user/mqtt_archives
å‹ç¼©æ‰¹æ¬¡å¤§å°: 5 å¼ å›¾ç‰‡/åŒ…
æ­£åœ¨è¿æ¥åˆ° MQTT æœåŠ¡å™¨ localhost:1883...
âœ“ å·²è¿æ¥åˆ°MQTTæœåŠ¡å™¨
å·²è®¢é˜…è¯é¢˜: ros2/image_compressed/data

å›¾åƒæ¥æ”¶å™¨å·²å¯åŠ¨
ç­‰å¾…å›¾åƒæ•°æ®...
æŒ‰ Ctrl+C é€€å‡º
============================================================

[14:32:01] æ”¶åˆ°æ¶ˆæ¯:
  è¯é¢˜: ros2/image_compressed/data
  æ•°æ®é•¿åº¦: 342156 å­—èŠ‚
  æ¶ˆæ¯ç±»å‹: JSON
  å‘ç°uint8_arrayå›¾åƒæ•°æ® (MQTTæ ¼å¼)
  æ•°æ®å¤§å°: 256959 å­—èŠ‚
  Base64æ•°æ®é•¿åº¦: 342612 å­—ç¬¦
  å¼€å§‹Base64è§£ç ...
  Base64è§£ç æˆåŠŸï¼Œå¾—åˆ° 256959 å­—èŠ‚
  å‡†å¤‡ä¿å­˜åˆ°: mqtt_images/ros2_image_compressed_data_20250722_143201_001_0001.jpg
  ä¿å­˜ä¸ºå‹ç¼©å›¾åƒæ–‡ä»¶...
âœ“ å‹ç¼©å›¾åƒå·²ä¿å­˜: ros2_image_compressed_data_20250722_143201_001_0001.jpg (256959 å­—èŠ‚)
  æ·»åŠ åˆ°æ‰“åŒ…é˜Ÿåˆ—: ros2_image_compressed_data_20250722_143201_001_0001.jpg (é˜Ÿåˆ—ä¸­ 1/5)

[... æ›´å¤šå›¾ç‰‡æ¥æ”¶ ...]

ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…: mqtt_images_batch_0001_20250722_143210.zip
   åŒ…å« 5 ä¸ªæ–‡ä»¶
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143201_001_0001.jpg
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143202_002_0002.jpg
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143203_003_0003.jpg
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143204_004_0004.jpg
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143205_005_0005.jpg
   ğŸ“Š å‹ç¼©å®Œæˆ:
      åŸå§‹å¤§å°: 1,284,795 å­—èŠ‚
      å‹ç¼©å: 1,278,234 å­—èŠ‚
      å‹ç¼©ç‡: 0.5%
   ğŸ’¾ ä¿å­˜åˆ°: mqtt_archives/mqtt_images_batch_0001_20250722_143210.zip
```

### ç¤ºä¾‹2ï¼šå¤„ç†å‰©ä½™æ–‡ä»¶
```bash
^C
æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œæ­£åœ¨é€€å‡º...

ğŸ“¦ å¤„ç†å‰©ä½™çš„ 3 ä¸ªæ–‡ä»¶...
ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…: mqtt_images_batch_0002_20250722_143230.zip
   åŒ…å« 3 ä¸ªæ–‡ä»¶
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143226_006_0006.jpg
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143227_007_0007.jpg
   âœ“ å·²æ·»åŠ : ros2_image_compressed_data_20250722_143228_008_0008.jpg
   ğŸ“Š å‹ç¼©å®Œæˆ:
      åŸå§‹å¤§å°: 770,877 å­—èŠ‚
      å‹ç¼©å: 766,540 å­—èŠ‚
      å‹ç¼©ç‡: 0.6%
   ğŸ’¾ ä¿å­˜åˆ°: mqtt_archives/mqtt_images_batch_0002_20250722_143230.zip

æ¥æ”¶ä¼šè¯ç»“æŸï¼Œå…±ä¿å­˜ 8 å¼ å›¾åƒ
å…±åˆ›å»º 2 ä¸ªå‹ç¼©åŒ…
å‹ç¼©åŒ…ä¿å­˜åœ¨: /home/user/mqtt_archives
```

## ğŸ”§ é«˜çº§åŠŸèƒ½

### å¯é€‰ï¼šåˆ é™¤å·²æ‰“åŒ…çš„åŸå§‹æ–‡ä»¶
å¦‚æœä½ æƒ³åœ¨åˆ›å»ºå‹ç¼©åŒ…ååˆ é™¤åŸå§‹å›¾ç‰‡æ–‡ä»¶ä»¥èŠ‚çœç©ºé—´ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Š `create_archive()` æ–¹æ³•ä¸­çš„è¿™è¡Œä»£ç ï¼š
```python
# self.cleanup_archived_files()  # å–æ¶ˆæ³¨é‡Šæ¥å¯ç”¨
```

### è‡ªå®šä¹‰å‹ç¼©çº§åˆ«
å½“å‰ä½¿ç”¨ `zipfile.ZIP_DEFLATED` å’Œ `compresslevel=6`ã€‚å¯ä»¥è°ƒæ•´ä»¥è·å¾—ä¸åŒçš„å‹ç¼©æ•ˆæœï¼š
- `compresslevel=1`: æœ€å¿«å‹ç¼©ï¼Œè¾ƒå¤§æ–‡ä»¶
- `compresslevel=9`: æœ€ä½³å‹ç¼©ï¼Œè¾ƒæ…¢é€Ÿåº¦

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å‹ç¼©åŒ…åˆ›å»ºå¤±è´¥**
   ```
   æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
   ç¡®è®¤å‹ç¼©åŒ…ç›®å½•æœ‰å†™å…¥æƒé™
   ```

2. **å‹ç¼©ç‡å¾ˆä½**
   ```
   JPEGå›¾ç‰‡å·²ç»æ˜¯å‹ç¼©æ ¼å¼ï¼Œå†å‹ç¼©æ•ˆæœæœ‰é™
   è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸»è¦ç›®çš„æ˜¯æ‰¹é‡æ‰“åŒ…ç®¡ç†
   ```

3. **å†…å­˜ä½¿ç”¨è¿‡é«˜**
   ```
   å‡å°‘ --archive-batch-size çš„å€¼
   é¿å…å¤„ç†è¿‡å¤§çš„å•ä¸ªå›¾ç‰‡æ–‡ä»¶
   ```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

- **æ‰¹æ¬¡å¤§å°å»ºè®®**: 5-20å¼ å›¾ç‰‡/åŒ…ï¼Œå¹³è¡¡å‹ç¼©æ•ˆç‡å’Œå¤„ç†é€Ÿåº¦
- **ç£ç›˜ç©ºé—´**: ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´å­˜å‚¨åŸå§‹æ–‡ä»¶å’Œå‹ç¼©åŒ…
- **å†…å­˜ä½¿ç”¨**: æ‰¹é‡å‹ç¼©æ—¶ä¼šæš‚æ—¶å ç”¨æ›´å¤šå†…å­˜

## ğŸ¯ ä½¿ç”¨åœºæ™¯

1. **é•¿æœŸæ•°æ®æ”¶é›†**: è‡ªåŠ¨å°†å›¾ç‰‡åˆ†æ‰¹æ‰“åŒ…ï¼Œä¾¿äºå­˜æ¡£
2. **ä¼ è¾“ä¼˜åŒ–**: å‹ç¼©åŒ…æ›´é€‚åˆç½‘ç»œä¼ è¾“
3. **å­˜å‚¨ç®¡ç†**: å‡å°‘æ–‡ä»¶æ•°é‡ï¼Œæé«˜æ–‡ä»¶ç³»ç»Ÿæ•ˆç‡
4. **å¤‡ä»½å½’æ¡£**: æŒ‰æ—¶é—´æ‰¹æ¬¡åˆ›å»ºå¤‡ä»½æ–‡ä»¶
